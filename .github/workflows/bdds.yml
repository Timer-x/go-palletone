name: BDDS
on: [push]
jobs:

  fabricbdd:
    name: UserContract-fabricbdd
    runs-on: ubuntu-latest
    steps:

    - name: Prepare fabric
      run: |
          cd $HOME
          mkdir gopath
          cd gopath
          export GOPATH=$pwd
          # create hyperledger directory
          mkdir -p src/github.com/hyperledger
          cd src/github.com/hyperledger
          # download fabric
          wget https://github.com/hyperledger/fabric/releases/download/v1.4.0/hyperledger-fabric-linux-amd64-1.4.0.tar.gz
          tar zxvf hyperledger-fabric-linux-amd64-1.4.0.tar.gz
          export PATH=$PATH:$HOME/gopath/src/github.com/hyperledger/bin
          peer version #test
          # download fabric-samples
          git clone -b v1.4.0 https://github.com/hyperledger/fabric-samples
          # pull docker images
          cd $HOME/gopath/src/github.com/hyperledger/fabric-samples/scripts
          ./bootstrap.sh -b
          docker images
          # start base-network
          cd $HOME/gopath/src/github.com/hyperledger/fabric-samples/basic-network
          ./start.sh
          docker-compose -f ./docker-compose.yml up -d cli
          docker ps -a
          # deploy chaincode_example02
          docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp" cli peer chaincode install -n chaincode_example02 -v 1.0 -p "github.com/chaincode_example02/go" -l "golang"
          docker exec -e "CORE_PEER_LOCALMSPID=Org1MSP" -e "CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp" cli peer chaincode instantiate -o orderer.example.com:7050 -C mychannel -n chaincode_example02 -l "golang" -v 1.0 -c '{"Args":["init","A","100000","B","1000"]}' -P "OR ('Org1MSP.member','Org2MSP.member')"
          sleep 10
          docker exec cli peer chaincode query -C mychannel -n chaincode_example02 -c '{"Function": "query", "Args": ["B"]}'


